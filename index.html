<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ZCTA adjacency map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    .info-box {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .legend {
      line-height: 18px;
      color: #333;
      background: white;
      padding: 6px 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 13px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    .legend button {
      margin-top: 6px;
      width: 100%;
      padding: 4px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background: #f8f8f8;
    }
    .legend button:hover {
      background: #eee;
    }
    .popup-link {
      color: #1f77b4;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-box" id="info">Click a ZCTA to highlight its adjacent ZCTAs</div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!--- SheetJS --->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
  const GEOJSON_URL = 'zcta.geojson';
  const PAIRS_CSV  = 'zcta_pairs.csv';
  const ID_FIELD   = 'GEOID20';

  const map = L.map('map').setView([39.0, -95.7], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Styles
  const defaultStyle   = { weight: 0.6, color: "#444", fillColor: "#ddd", fillOpacity: 0.6 };
  const selectedStyle  = { weight: 2.5, color: "#d62728", fillColor: "#d62728", fillOpacity: 0.45 }; // red
  const keepStyle      = { weight: 2.2, color: "#1f77b4", fillColor: "#1f77b4", fillOpacity: 0.35 }; // blue
  const nonKeepStyle   = { weight: 1.5, color: "#8c564b", fillColor: "#8c564b", fillOpacity: 0.25 }; // brown

  // adjacency: { id -> { keep: Set(), nonKeep: Set() } }
  const adjacency = new Map();

function loadPairs() {
  return fetch("zcta_pairs.xlsx")
    .then(res => res.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: "array" });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

      rows.forEach(row => {
        const a = String(row['GEOID20']).padStart(5, '0');   // ensure string with leading zeros
        const b = String(row['GEOID20.1']).padStart(5, '0');
        const keep = String(row['keep']).trim();

        if (!a || !b) return;

        if (!adjacency.has(a)) adjacency.set(a, { keep: new Set(), nonKeep: new Set() });
        if (!adjacency.has(b)) adjacency.set(b, { keep: new Set(), nonKeep: new Set() });

        if (keep === "1") {
          adjacency.get(a).keep.add(b);
          adjacency.get(b).keep.add(a);
        } else {
          adjacency.get(a).nonKeep.add(b);
          adjacency.get(b).nonKeep.add(a);
        }
      });
    });
}

  let zctaLayer = L.geoJSON(null, { style: defaultStyle, onEachFeature }).addTo(map);
  const idToLayer = new Map();

  function onEachFeature(feature, layer) {
    const id = feature.properties[ID_FIELD];
    idToLayer.set(String(id), layer);
    layer.bindTooltip(String(id), { direction: 'center' });
    layer.on({ click: onFeatureClick });
  }

  function resetStyles() {
    idToLayer.forEach(layer => layer.setStyle(defaultStyle));
    document.getElementById('info').innerText = 'Click a ZCTA to highlight its adjacent ZCTAs';
    map.closePopup();
  }

  function onFeatureClick(e, overrideId=null) {
    const id = overrideId || String(e?.target?.feature?.properties[ID_FIELD]);
    if (!id) return;
    const layer = idToLayer.get(id);
    if (!layer) return;

    const entry = adjacency.get(id) || { keep: new Set(), nonKeep: new Set() };
    const keepNeighbors = Array.from(entry.keep);
    const nonKeepNeighbors = Array.from(entry.nonKeep);

    idToLayer.forEach(l => l.setStyle(defaultStyle));

    layer.setStyle(selectedStyle);

    keepNeighbors.forEach(nid => {
      const nl = idToLayer.get(String(nid));
      if (nl) nl.setStyle(keepStyle);
    });

    nonKeepNeighbors.forEach(nid => {
      const nl = idToLayer.get(String(nid));
      if (nl) nl.setStyle(nonKeepStyle);
    });

    // Build popup with clickable links
    const keepLinks = keepNeighbors.length
      ? keepNeighbors.map(n => `<span class="popup-link" data-zip="${n}">${n}</span>`).join(', ')
      : 'None';

    const nonKeepLinks = nonKeepNeighbors.length
      ? nonKeepNeighbors.map(n => `<span class="popup-link" data-zip="${n}">${n}</span>`).join(', ')
      : 'None';

    const popupHtml = `<div><strong>ZCTA:</strong> ${id}</div>
      <div><strong>Neighbors (keep==1):</strong> ${keepLinks}</div>
      <div><strong>Neighbors (keep==0):</strong> ${nonKeepLinks}</div>`;

    layer.bindPopup(popupHtml).openPopup();

    document.getElementById('info').innerText =
      `Selected: ${id} â€” ${keepNeighbors.length} keep==1, ${nonKeepNeighbors.length} keep==0 neighbors`;

    // Zoom to bounds of selected layer
    try {
      map.fitBounds(layer.getBounds(), { padding: [20,20] });
    } catch(err){}

    // Attach click events to popup links
    map.once("popupopen", () => {
      document.querySelectorAll(".popup-link").forEach(el => {
        el.addEventListener("click", () => {
          const targetId = el.getAttribute("data-zip");
          onFeatureClick(null, targetId); // re-run selection
        });
      });
    });
  }

  Promise.all([ loadPairs(), fetch(GEOJSON_URL).then(r => r.json()) ])
    .then(([_, geojson]) => {
      zctaLayer.addData(geojson);
      const b = zctaLayer.getBounds();
      if (b.isValid()) map.fitBounds(b);
    })
    .catch(err => console.error(err));

  // --- Legend Control with Reset Button ---
  const legend = L.control({position: 'bottomright'});
  legend.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <strong>Legend</strong><br>
      <i style="background:#d62728"></i> Selected ZIP<br>
      <i style="background:#1f77b4"></i> Neighbor (keep==1)<br>
      <i style="background:#8c564b"></i> Neighbor (keep==0)<br>
      <i style="background:#ddd; border:1px solid #444"></i> Other ZIPs
      <br><button id="resetBtn">Reset Map</button>
    `;
    return div;
  };
  legend.addTo(map);

  map.whenReady(() => {
    const btn = document.getElementById('resetBtn');
    if (btn) btn.addEventListener('click', resetStyles);
  });
  </script>
</body>
</html>